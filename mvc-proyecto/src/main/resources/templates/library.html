<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Biblioteca - Sistema de Gesti√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}"/>    <style>
        body {
            background: linear-gradient(135deg, #f7e6d3 0%, #f0c6a0 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-modern {
            background: rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-modern .navbar-brand,
        .navbar-modern .nav-link {
            color: white !important;
            font-weight: 600;
            transition: all 0.3s ease;
        }        .navbar-modern .nav-link:hover {
            color: #d4915c !important;
            transform: translateY(-2px);
        }
        
        .navbar-modern .nav-link.active {
            color: #d4915c !important;
            border-bottom: 2px solid #d4915c;
        }
        
        .hero-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .modern-tabs {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .modern-tabs .nav-link {
            color: white;
            border: none;
            border-radius: 10px;
            margin: 0 0.25rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background: transparent;
        }
        
        .modern-tabs .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
        }        .modern-tabs .nav-link.active {
            background: rgba(255, 255, 255, 0.9);
            color: #d4915c;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.15);
        }        .glass-card .card-header {
            background: linear-gradient(45deg, #d4915c, #c97a3e);
            color: white;
            border: none;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
            font-weight: 600;
        }
        
        .glass-card .card-body {
            padding: 2rem;
        }
        
        .btn-modern {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }        .btn-primary-modern {
            background: linear-gradient(45deg, #d4915c, #c97a3e);
            color: white;
        }
        
        .btn-primary-modern:hover {
            background: linear-gradient(45deg, #c97a3e, #d4915c);
            transform: scale(1.05);
            color: white;
        }
        
        .btn-secondary-modern {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-secondary-modern:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
            transform: scale(1.05);
            color: white;
        }        .btn-success-modern {
            background: linear-gradient(45deg, #90c695, #7bb77f);
            color: white;
        }
        
        .btn-success-modern:hover {
            background: linear-gradient(45deg, #7bb77f, #90c695);
            transform: scale(1.05);
            color: white;
        }
        
        .btn-danger-modern {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
        }
        
        .btn-danger-modern:hover {
            background: linear-gradient(45deg, #feca57, #ff6b6b);
            transform: scale(1.05);
            color: white;
        }
          .form-control-modern {
            border: 2px solid rgba(212, 145, 92, 0.3);
            border-radius: 15px;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }
        
        .form-control-modern:focus {
            border-color: #d4915c;
            box-shadow: 0 0 0 0.2rem rgba(212, 145, 92, 0.25);
            background: white;
        }
        
        .table-modern {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }        .table-modern thead th {
            background: linear-gradient(45deg, #d4915c, #c97a3e);
            color: white;
            border: none;
            padding: 1rem;
            font-weight: 600;
        }
        
        .table-modern tbody td {
            padding: 1rem;
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .icon-header {
            font-size: 2rem;
            margin-right: 0.5rem;
        }
        
        .section-header {
            background: linear-gradient(45deg, #fa709a, #fee140);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-modern">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-house-door me-2"></i>Portal Principal
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/calc">
                    <i class="bi bi-calculator me-1"></i>C√°lculo
                </a>
                <a class="nav-link" href="/grades">
                    <i class="bi bi-mortarboard me-1"></i>Calificaciones
                </a>
                <a class="nav-link active" href="/library">
                    <i class="bi bi-book me-1"></i>Biblioteca
                </a>
            </div>
        </div>
    </nav>

    <!-- Hero Header -->
    <div class="hero-header">
        <h1 class="display-5 fw-bold mb-3">
            <i class="bi bi-book icon-header"></i>
            Gesti√≥n de Biblioteca
        </h1>
        <p class="lead mb-0">
            Administra libros, usuarios y pr√©stamos de manera eficiente
        </p>
    </div>

    <!-- Modern Tabs -->
    <div class="modern-tabs">
        <ul class="nav nav-tabs border-0" id="libraryTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="books-tab" data-bs-toggle="tab" data-bs-target="#books" type="button" role="tab">
                    <i class="bi bi-book me-2"></i>Libros
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                    <i class="bi bi-people me-2"></i>Usuarios
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="loans-tab" data-bs-toggle="tab" data-bs-target="#loans" type="button" role="tab">
                    <i class="bi bi-calendar-check me-2"></i>Pr√©stamos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab">
                    <i class="bi bi-graph-up me-2"></i>Reporte
                </button>
            </li>
        </ul>
    </div>

    <div class="tab-content" id="libraryTabContent">
        <!-- Gesti√≥n de Libros -->
        <div class="tab-pane fade show active" id="books" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-plus-circle me-2"></i>Crear Nuevo Libro
                            </h5>
                        </div>
                        <div class="card-body">                            <form id="createBookForm">
                                <div class="mb-3">                                    <label for="bookTitle" class="form-label fw-bold">
                                        <i class="bi bi-type me-1"></i>T√≠tulo del Libro
                                    </label>
                                    <input type="text" class="form-control form-control-modern" id="bookTitle" name="title" required>
                                </div>
                                <button type="submit" class="btn btn-modern btn-success-modern w-100">
                                    <i class="bi bi-plus-circle me-2"></i>Crear Libro
                                </button>
                            </form>
                            <div id="bookCreateResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-list me-2"></i>Lista de Libros
                            </h5>
                        </div>
                        <div class="card-body">                            <button class="btn btn-modern btn-primary-modern mb-3" id="listBooksBtn">
                                <i class="bi bi-arrow-clockwise me-2"></i>Actualizar Lista
                            </button>
                            <div id="booksList">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-book fs-1 mb-3 d-block"></i>
                                    <p>Haz clic en "Actualizar Lista" para ver los libros registrados</p>
                                    <small>Los libros aparecer√°n aqu√≠ una vez que los hayas creado</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gesti√≥n de Usuarios -->
        <div class="tab-pane fade" id="users" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-person-plus me-2"></i>Crear Nuevo Usuario
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="createUserForm">
                                <div class="mb-3">
                                    <label for="userName" class="form-label fw-bold">
                                        <i class="bi bi-person me-1"></i>Nombre Completo
                                    </label>
                                    <input type="text" class="form-control form-control-modern" id="userName" name="name" required 
                                           placeholder="Ej: Juan P√©rez Garc√≠a" minlength="3" maxlength="100">
                                    <small class="form-text text-muted">M√≠nimo 3 caracteres, m√°ximo 100</small>
                                </div>
                                <div class="mb-3">
                                    <label for="userRole" class="form-label fw-bold">
                                        <i class="bi bi-person-badge me-1"></i>Rol en la Instituci√≥n
                                    </label>
                                    <select class="form-select form-control-modern" id="userRole" name="role" required>
                                        <option value="">Seleccionar rol...</option>
                                        <option value="ESTUDIANTE">üë®‚Äçüéì Estudiante</option>
                                        <option value="EMPLEADO">üë®‚Äçüíº Empleado</option>
                                        <option value="DOCENTE">üë®‚Äçüè´ Docente</option>
                                    </select>
                                    <small class="form-text text-muted">El rol determina los permisos de pr√©stamo</small>
                                </div>
                                <button type="submit" class="btn btn-modern btn-success-modern w-100">
                                    <i class="bi bi-person-plus me-2"></i>Crear Usuario
                                </button>
                            </form>
                            <div id="userCreateResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-people me-2"></i>Lista de Usuarios
                            </h5>
                        </div>
                        <div class="card-body">                            <button class="btn btn-modern btn-primary-modern mb-3" id="listUsersBtn">
                                <i class="bi bi-arrow-clockwise me-2"></i>Actualizar Lista
                            </button>                            <div id="usersList">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-people fs-1 mb-3 d-block"></i>
                                    <p>Haz clic en "Actualizar Lista" para ver los usuarios registrados</p>
                                    <small>Los usuarios aparecer√°n aqu√≠ una vez que los hayas creado</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gesti√≥n de Pr√©stamos -->
        <div class="tab-pane fade" id="loans" role="tabpanel">
            <div class="row mb-3">
                <div class="col-12">
                    <div class="glass-card">
                        <div class="card-body p-3">
                            <button type="button" id="refreshLoanSelectorsBtn" class="btn btn-modern btn-info-modern btn-sm">
                                <i class="bi bi-arrow-clockwise me-2"></i>Actualizar Lista de Usuarios y Libros
                            </button>
                            <small class="text-muted ms-2">Haz clic aqu√≠ para cargar los usuarios y libros disponibles</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-book me-2"></i>Crear Nuevo Pr√©stamo
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="createLoanForm">
                                <div class="mb-3">
                                    <label for="loanUserId" class="form-label fw-bold">
                                        <i class="bi bi-person me-1"></i>Usuario
                                    </label>
                                    <select class="form-select form-control-modern" id="loanUserId" name="userId" required>
                                        <option value="">Seleccionar usuario...</option>
                                        <!-- Los usuarios se cargar√°n din√°micamente -->
                                    </select>
                                    <small class="form-text text-muted">Selecciona el usuario que realizar√° el pr√©stamo</small>
                                </div>
                                <div class="mb-3">
                                    <label for="loanIsbn" class="form-label fw-bold">
                                        <i class="bi bi-book me-1"></i>Libro
                                    </label>
                                    <select class="form-select form-control-modern" id="loanIsbn" name="isbn" required>
                                        <option value="">Seleccionar libro...</option>
                                        <!-- Los libros se cargar√°n din√°micamente -->
                                    </select>
                                    <small class="form-text text-muted">Selecciona el libro a prestar</small>
                                </div>
                                <div class="mb-3">
                                    <label for="loanDate" class="form-label fw-bold">
                                        <i class="bi bi-calendar me-1"></i>Fecha de Pr√©stamo
                                    </label>
                                    <input type="date" class="form-control form-control-modern" id="loanDate" name="loanDate" required>
                                    <small class="form-text text-muted">Fecha en que se realiza el pr√©stamo</small>
                                </div>
                                <button type="submit" class="btn btn-modern btn-success-modern w-100">
                                    <i class="bi bi-book me-2"></i>Crear Pr√©stamo
                                </button>
                            </form>
                            <div id="loanCreateResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-list-check me-2"></i>Pr√©stamos Activos
                            </h5>
                            <button type="button" id="listLoansBtn" class="btn btn-modern btn-primary-modern btn-sm">
                                <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
                            </button>
                        </div>
                        <div class="card-body">                            <div id="loansList">
                                <div class="text-center text-muted py-4">
                                    <i class="bi bi-calendar-check fs-1 mb-3 d-block"></i>
                                    <p>Haz clic en "Actualizar" para cargar los pr√©stamos activos</p>
                                    <small>Los pr√©stamos aparecer√°n aqu√≠ una vez que los hayas creado</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reporte -->
        <div class="tab-pane fade" id="report" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="glass-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up me-2"></i>Reporte General de Biblioteca
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-12">
                                    <button type="button" id="getReportBtn" class="btn btn-modern btn-primary-modern">
                                        <i class="bi bi-file-earmark-bar-graph me-2"></i>Generar Reporte
                                    </button>
                                    <small class="text-muted ms-2">Obtiene un resumen completo del estado actual de la biblioteca</small>
                                </div>
                            </div>
                            <div id="reportResult">
                                <div class="text-center text-muted">
                                    <i class="bi bi-file-earmark-bar-graph fs-1 mb-3 d-block"></i>
                                    <p>Haz clic en "Generar Reporte" para obtener estad√≠sticas completas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                </div>
            </div>
            <div id="libraryReport"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    
    // Establecer fecha actual por defecto en el formulario de pr√©stamos
    var today = new Date().toISOString().split('T')[0];
    $('#loanDate').val(today);
    
    // === FUNCIONES DE UTILIDAD PARA AUTO-ACTUALIZACI√ìN ===
    
    // Funci√≥n para actualizar lista de usuarios y estad√≠sticas
    function updateUsersList() {
        $.get('/library/users/list')
            .done(function(data) {
                $('#usersList').html(data);
                // Calcular estad√≠sticas de usuarios
                updateUserStatistics();
            })
            .fail(function() {
                $('#usersList').html('<div class="alert alert-danger">Error al cargar usuarios</div>');
            });
    }
    
    // Funci√≥n para actualizar estad√≠sticas de usuarios
    function updateUserStatistics() {
        // Contar usuarios por rol desde la lista visible
        var totalUsers = $('#usersList .list-group-item').length;
        var estudiantes = $('#usersList .list-group-item:contains("üë®‚Äçüéì")').length;
        var empleados = $('#usersList .list-group-item:contains("üë®‚Äçüíº")').length;
        var docentes = $('#usersList .list-group-item:contains("üë®‚Äçüè´")').length;
        
        // Actualizar contadores
        $('#totalUsers').text(totalUsers);
        $('#totalStudents').text(estudiantes);
        $('#totalEmployees').text(empleados);
        $('#totalTeachers').text(docentes);
    }
    
    // Funci√≥n para actualizar lista de libros si est√° visible
    function updateBooksList() {
        if ($('#booksList').is(':visible') && $('#booksList').children().length > 0) {
            $('#listBooksBtn').click();
        }
    }
    
    // Funci√≥n para actualizar lista de pr√©stamos si est√° visible
    function updateLoansList() {
        if ($('#loansList').is(':visible') && $('#loansList').children().length > 0) {
            $('#listLoansBtn').click();
        }
    }
    
    // Funci√≥n para actualizar selectores de usuarios en pr√©stamos
    function updateLoanUserSelector() {
        $.get('/library/users/options')
            .done(function(users) {
                var $select = $('#loanUserId');
                var currentValue = $select.val();
                $select.empty().append('<option value="">Seleccionar usuario...</option>');
                
                $.each(users, function(index, user) {
                    var roleIcon = '';
                    if (user.role === 'ESTUDIANTE') roleIcon = 'üë®‚Äçüéì';
                    else if (user.role === 'EMPLEADO') roleIcon = 'üë®‚Äçüíº';
                    else if (user.role === 'DOCENTE') roleIcon = 'üë®‚Äçüè´';
                    
                    var optionText = roleIcon + ' ' + user.name + ' (' + user.role + ')';
                    $select.append('<option value="' + user.id + '"' + 
                                 (user.id === currentValue ? ' selected' : '') + '>' + 
                                 optionText + '</option>');
                });
            })
            .fail(function() {
                console.log('Error al cargar usuarios para pr√©stamos');
            });
    }
    
    // Funci√≥n para actualizar selectores de libros en pr√©stamos
    function updateLoanBookSelector() {
        $.get('/library/books/options')
            .done(function(books) {
                var $select = $('#loanIsbn');
                var currentValue = $select.val();
                $select.empty().append('<option value="">Seleccionar libro...</option>');
                
                $.each(books, function(index, book) {
                    var optionText = 'üìö ' + book.title + ' (ISBN: ' + book.isbn + ')';
                    $select.append('<option value="' + book.isbn + '"' + 
                                 (book.isbn === currentValue ? ' selected' : '') + '>' + 
                                 optionText + '</option>');
                });
            })
            .fail(function() {
                console.log('Error al cargar libros para pr√©stamos');
            });
    }
    
    // Funci√≥n para actualizar estad√≠sticas de pr√©stamos
    function updateLoanStatistics(loans) {
        if (!loans || !Array.isArray(loans)) return;
        
        var totalLoans = loans.length;
        var activeLoans = loans.filter(loan => loan.returnDate === null).length;
        var overdueLoans = loans.filter(loan => loan.daysOverdue > 0).length;
        var totalFines = loans.reduce((sum, loan) => sum + (loan.fine || 0), 0);
        
        $('#totalLoans').text(totalLoans);
        $('#activeLoans').text(activeLoans);
        $('#overdueLoans').text(overdueLoans);
        $('#totalFines').text('$' + totalFines.toFixed(2));
    }
    
    // Funci√≥n para actualizar lista de pr√©stamos si est√° visible
    function updateLoansList() {
        if ($('#loansList').is(':visible') && $('#loansList').children().length > 0) {
            $('#listLoansBtn').click();
        }
    }
      // Cargar datos iniciales
    updateUsersList();
    updateLoanUserSelector();
    updateLoanBookSelector();
    
    // Establecer fecha actual como predeterminada
    $('#loanDate').val(new Date().toISOString().split('T')[0]);
    
    // === FUNCIONES DE GESTI√ìN CON AUTO-ACTUALIZACI√ìN ===
    
    // Refrescar selectores de pr√©stamos
    $('#refreshLoanSelectorsBtn').click(function() {
        var $btn = $(this);
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> Actualizando...');
        
        updateLoanUserSelector();
        updateLoanBookSelector();
        
        setTimeout(function() {
            $btn.prop('disabled', false).html('üîÑ Actualizar Lista de Usuarios y Libros');
        }, 1000);
    });
    
    // === FUNCIONES DE GESTI√ìN CON AUTO-ACTUALIZACI√ìN ===      // Crear libro
    $('#createBookForm').on('submit', function(e) {
        e.preventDefault();
        
        // Debug: verificar que el t√≠tulo se env√≠a
        var formData = $(this).serialize();
        console.log('Datos del formulario de libro:', formData);
        
        // Validar que el t√≠tulo est√© lleno
        var title = $('#bookTitle').val().trim();
        
        if (!title) {
            $('#bookCreateResult').html('<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> El t√≠tulo del libro es requerido</div>');
            return;
        }
        
        // Mostrar mensaje de carga
        $('#bookCreateResult').html('<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Creando libro...</div>');
        
        $.post('/library/books/create', formData)
            .done(function(data) {
                $('#bookCreateResult').html(data);
                
                // Auto-actualizar listas relacionadas
                setTimeout(function() {
                    updateBooksList();
                    updateLoansList(); // Los pr√©stamos pueden verse afectados
                }, 500);
                
                // Limpiar formulario si fue exitoso
                if (data.includes('alert-success') || data.includes('success')) {
                    $('#createBookForm')[0].reset();
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Error al crear libro:', error);
                $('#bookCreateResult').html('<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error al crear libro: ' + error + '</div>');
            });
    });

    // Listar libros
    $('#listBooksBtn').click(function() {
        var $btn = $(this);
        var originalText = $btn.html();
        
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> Cargando...');
        
        $.get('/library/books/list')
            .done(function(data) {
                $('#booksList').html(data);
            })
            .fail(function() {
                $('#booksList').html('<div class="alert alert-danger">Error al cargar libros</div>');
            })
            .always(function() {
                $btn.prop('disabled', false).html(originalText);
            });
    });

    // Crear usuario con validaciones mejoradas
    $('#createUserForm').on('submit', function(e) {
        e.preventDefault();
        
        // Validaciones adicionales del cliente
        var userName = $('#userName').val().trim();
        var userRole = $('#userRole').val();
        
        if (userName.length < 3) {
            $('#userCreateResult').html('<div class="alert alert-warning">El nombre debe tener al menos 3 caracteres</div>');
            return;
        }
        
        if (!userRole) {
            $('#userCreateResult').html('<div class="alert alert-warning">Debe seleccionar un rol</div>');
            return;
        }
        
        $.post('/library/users/create', $(this).serialize())
            .done(function(data) {
                $('#userCreateResult').html(data);
                
                // Auto-actualizar listas relacionadas
                setTimeout(function() {
                    updateUsersList();
                    updateLoansList(); // Los pr√©stamos pueden verse afectados
                }, 500);
                
                // Limpiar formulario si fue exitoso
                if (data.includes('alert-success')) {
                    $('#createUserForm')[0].reset();
                }
            })
            .fail(function() {
                $('#userCreateResult').html('<div class="alert alert-danger">Error al crear usuario</div>');
            });
    });

    // Listar usuarios con estad√≠sticas
    $('#listUsersBtn').click(function() {
        var $btn = $(this);
        var originalText = $btn.html();
        
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> Cargando...');
        
        updateUsersList();
        
        setTimeout(function() {
            $btn.prop('disabled', false).html(originalText);
        }, 1000);
    });    // Crear pr√©stamo con validaciones mejoradas
    $('#createLoanForm').on('submit', function(e) {
        e.preventDefault();
        
        // Validaciones adicionales del cliente
        var userId = $('#loanUserId').val();
        var isbn = $('#loanIsbn').val();
        var loanDate = $('#loanDate').val();
        
        if (!userId) {
            $('#loanCreateResult').html('<div class="alert alert-warning">Debe seleccionar un usuario</div>');
            return;
        }
        
        if (!isbn) {
            $('#loanCreateResult').html('<div class="alert alert-warning">Debe seleccionar un libro</div>');
            return;
        }
        
        if (!loanDate) {
            $('#loanCreateResult').html('<div class="alert alert-warning">Debe especificar la fecha del pr√©stamo</div>');
            return;
        }
        
        $.post('/library/loans/create', $(this).serialize())
            .done(function(data) {
                $('#loanCreateResult').html(data);
                
                // Auto-actualizar lista de pr√©stamos
                setTimeout(function() {
                    updateLoansList();
                }, 500);
                
                // Limpiar formulario si fue exitoso
                if (data.includes('alert-success')) {
                    $('#createLoanForm')[0].reset();
                    // Restaurar fecha actual
                    $('#loanDate').val(new Date().toISOString().split('T')[0]);
                }
            })
            .fail(function() {
                $('#loanCreateResult').html('<div class="alert alert-danger">Error al crear pr√©stamo</div>');
            });
    });    // Listar pr√©stamos con estad√≠sticas
    $('#listLoansBtn').click(function() {
        var $btn = $(this);
        var originalText = $btn.html();
        
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> Cargando...');
        
        // Primero obtener los datos JSON para las estad√≠sticas
        $.get('/library/loans/data')
            .done(function(loansData) {
                // Actualizar estad√≠sticas
                updateLoanStatistics(loansData);
                
                // Luego cargar el fragmento HTML
                $.get('/library/loans/list')
                    .done(function(htmlData) {
                        $('#loansList').html(htmlData);
                    })
                    .fail(function() {
                        $('#loansList').html('<div class="alert alert-danger">Error al cargar pr√©stamos</div>');
                    });
            })
            .fail(function() {
                // Si falla la carga de datos, al menos intentar cargar la lista
                $.get('/library/loans/list')
                    .done(function(data) {
                        $('#loansList').html(data);
                    })
                    .fail(function() {
                        $('#loansList').html('<div class="alert alert-danger">Error al cargar pr√©stamos</div>');
                    });
            })
            .always(function() {
                $btn.prop('disabled', false).html(originalText);
            });
    });    // Generar reporte
    $('#getReportBtn').click(function() {
        var $btn = $(this);
        var originalText = $btn.html();
        
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status"></span> Generando...');
        
        $.get('/library/report')
            .done(function(data) {
                displayLibraryReport(data);
            })
            .fail(function() {
                $('#libraryReport').html('<div class="alert alert-danger">Error al generar reporte</div>');
            })
            .always(function() {
                $btn.prop('disabled', false).html(originalText);
            });
    });

    // Funci√≥n para mostrar el reporte de biblioteca
    function displayLibraryReport(reportData) {
        var html = '<div class="container-fluid">';
        
        // Resumen estad√≠stico
        html += '<div class="row mb-4">';
        html += '<div class="col-12"><h4 class="text-primary">üìà Resumen Estad√≠stico</h4></div>';
        html += '<div class="col-md-3">';
        html += '<div class="card bg-primary text-white">';
        html += '<div class="card-body text-center">';
        html += '<h2>' + reportData.books.length + '</h2>';
        html += '<p class="mb-0">Total de Libros</p>';
        html += '</div></div></div>';
        
        html += '<div class="col-md-3">';
        html += '<div class="card bg-success text-white">';
        html += '<div class="card-body text-center">';
        html += '<h2>' + reportData.users.length + '</h2>';
        html += '<p class="mb-0">Usuarios Registrados</p>';
        html += '</div></div></div>';
        
        html += '<div class="col-md-3">';
        html += '<div class="card bg-warning text-white">';
        html += '<div class="card-body text-center">';
        html += '<h2>' + reportData.activeLoans.length + '</h2>';
        html += '<p class="mb-0">Pr√©stamos Activos</p>';
        html += '</div></div></div>';
        
        html += '<div class="col-md-3">';
        html += '<div class="card bg-danger text-white">';
        html += '<div class="card-body text-center">';
        html += '<h2>$' + reportData.totalFines + '</h2>';
        html += '<p class="mb-0">Multas Pendientes</p>';
        html += '</div></div></div>';
        html += '</div>';
        
        // Estad√≠sticas por rol de usuario
        var estudiantes = reportData.users.filter(u => u.role === 'ESTUDIANTE').length;
        var docentes = reportData.users.filter(u => u.role === 'DOCENTE').length;
        var empleados = reportData.users.filter(u => u.role === 'EMPLEADO').length;
        
        html += '<div class="row mb-4">';
        html += '<div class="col-12"><h4 class="text-primary">üë• Distribuci√≥n de Usuarios por Rol</h4></div>';
        html += '<div class="col-md-4">';
        html += '<div class="card bg-info text-white">';
        html += '<div class="card-body text-center">';
        html += '<h3>' + estudiantes + '</h3>';
        html += '<p class="mb-0">üë®‚Äçüéì Estudiantes</p>';
        html += '</div></div></div>';
        
        html += '<div class="col-md-4">';
        html += '<div class="card bg-secondary text-white">';
        html += '<div class="card-body text-center">';
        html += '<h3>' + empleados + '</h3>';
        html += '<p class="mb-0">üë®‚Äçüíº Empleados</p>';
        html += '</div></div></div>';
        
        html += '<div class="col-md-4">';
        html += '<div class="card bg-dark text-white">';
        html += '<div class="card-body text-center">';
        html += '<h3>' + docentes + '</h3>';
        html += '<p class="mb-0">üë®‚Äçüè´ Docentes</p>';
        html += '</div></div></div>';
        html += '</div>';
        
        // Lista de pr√©stamos activos
        html += '<div class="row mb-4">';
        html += '<div class="col-12"><h4 class="text-primary">üìö Pr√©stamos Activos</h4></div>';
        html += '<div class="col-12">';
        
        if (reportData.activeLoans.length > 0) {
            html += '<div class="table-responsive">';
            html += '<table class="table table-striped table-hover">';
            html += '<thead class="table-dark">';
            html += '<tr><th>Usuario</th><th>Libro</th><th>Fecha Pr√©stamo</th><th>Fecha Vencimiento</th><th>D√≠as Vencidos</th><th>Multa</th></tr>';
            html += '</thead><tbody>';
            
            reportData.activeLoans.forEach(function(loan) {
                var user = reportData.users.find(u => u.id === loan.userId);
                var book = reportData.books.find(b => b.isbn === loan.isbn);
                var userName = user ? user.name : 'Usuario no encontrado';
                var bookTitle = book ? book.title : 'Libro no encontrado';
                
                var rowClass = loan.daysOverdue > 0 ? 'table-danger' : '';
                html += '<tr class="' + rowClass + '">';
                html += '<td>' + userName + '</td>';
                html += '<td>' + bookTitle + '</td>';
                html += '<td>' + loan.loanDate + '</td>';
                html += '<td>' + loan.dueDate + '</td>';
                html += '<td>' + (loan.daysOverdue > 0 ? loan.daysOverdue + ' d√≠as' : 'Al d√≠a') + '</td>';
                html += '<td>$' + loan.fine + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
        } else {
            html += '<div class="alert alert-info">No hay pr√©stamos activos en este momento.</div>';
        }
        
        html += '</div></div>';
        
        // Lista de libros disponibles
        html += '<div class="row mb-4">';
        html += '<div class="col-12"><h4 class="text-primary">üìñ Cat√°logo de Libros</h4></div>';
        html += '<div class="col-12">';
        html += '<div class="table-responsive">';
        html += '<table class="table table-striped">';
        html += '<thead class="table-primary">';
        html += '<tr><th>ISBN</th><th>T√≠tulo</th><th>Estado</th></tr>';
        html += '</thead><tbody>';
        
        reportData.books.forEach(function(book) {
            var isLoaned = reportData.activeLoans.some(loan => loan.isbn === book.isbn);
            var status = isLoaned ? '<span class="badge bg-warning">Prestado</span>' : '<span class="badge bg-success">Disponible</span>';
            
            html += '<tr>';
            html += '<td><code>' + book.isbn + '</code></td>';
            html += '<td>' + book.title + '</td>';
            html += '<td>' + status + '</td>';
            html += '</tr>';
        });
        
        html += '</tbody></table></div></div></div>';
        
        html += '</div>'; // Cierre del container-fluid
        
        $('#libraryReport').html(html);
    }
      // Auto-cargar estad√≠sticas cuando se activa la pesta√±a de usuarios
    $('button[data-bs-target="#users"]').on('shown.bs.tab', function() {
        updateUsersList();
    });
    
    // Auto-cargar datos cuando se activa la pesta√±a de pr√©stamos
    $('button[data-bs-target="#loans"]').on('shown.bs.tab', function() {
        updateLoanUserSelector();
        updateLoanBookSelector();
    });
});
</script>
</body>
</html>